function csrfSafeMethod(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}function toLines(e,t){let n=e.split("\n"),l=0,a=null,s=null;for(var i=0;i<length(n);i++){if(null===a&&l+length(n[i])>=t.start&&(a={line:i,pos:t.start-l}),l+length(n[i])>=t.end){s={line:i,pos:t.end-l};break}l=l+length(n[i])+1}return{lines:n,selection:{start:a,end:s}}}function length(e){return e.length}function createPreview(e,t,n){$.post(n,{md:e.value},(function(e,n,l){t.find(".preview").html(e).slideDown()}))}function MarkdownHelper(e,t){let n,l,a,s,i,r,o,c,d,u,b,g,h;if(13===t.keyCode&&(n=!1,l=e.value.replace(/\r\n/g,"\n"),e.selectionStart?a=e.selectionStart:(e.focus(),s=document.selection.createRange(),s.moveStart("character",-l.length),a=s.text.replace(/\r\n/g,"\n").length),i=l.split("\n"),r=l.substr(0,a).split("\n").length,o=i[r-1].replace(/^\s+/,""),c=o.substr(0,2),new RegExp("^[0-9]+[.] (.*)$").test(o)&&(d=o.substr(0,o.indexOf(". ")),b=d+". ",u=parseInt(d,10)+1+". ",n=!0),o&&!n&&"    "===i[r-1].substr(0,4)&&(b=u="    ",n=!0),["* ","+ ","- "].indexOf(c)>=0&&(b=u=c,n=!0),n))return g=i[r-1].indexOf(b),o.replace(/^\s+/,"")===b?(e.value=l.substr(0,a-1-g-u.length)+"\n\n"+l.substr(a,l.length),h=a+1-u.length-g):(e.value=l.substr(0,a)+"\n"+new Array(g+1).join(" ")+u+l.substr(a,l.length),h=a+1+u.length+g),e.selectionStart?e.setSelectionRange(h,h):(s=e.createTextRange(),s.move("character",h),s.select()),!1}function getCookie(e){var t=null;if(document.cookie&&""!==document.cookie)for(var n=document.cookie.split(";"),l=0;l<n.length;l++){var a=n[l].trim();if(a.substring(0,e.length+1)===e+"="){t=decodeURIComponent(a.substring(e.length+1));break}}return t}$.ajaxSetup({beforeSend:function(e,t){if(!csrfSafeMethod(t.type)&&!this.crossDomain){var n=getCookie("csrftoken");e.setRequestHeader("X-CSRFToken",n)}}}),function(e,t,n,l){e.fn.MarkdownEditor=function(t){var n=function(e,t){let n=e.value,l=t;if(n.indexOf("\r\n")>-1){let e=n.replace(/\r\n/g,"\n").slice(0,t).match(/\n/g);l+=e?e.length:0}return l},l={bold:{start:"**",end:"**",placeholder:"Your bold text",line:!1,block:!1},strike:{start:"~~",end:"~~",placeholder:"Your struckthrough text",line:!1,block:!1},italic:{start:"*",end:"*",placeholder:"Your emphasized text",line:!1,block:!1},h1:{start:"# ",end:"",placeholder:"Your header",line:!0,block:!1},h2news:{start:"## ",end:" {.news-bg}",placeholder:"Your header",line:!0,block:!1},h3news:{start:"### ",end:" {.news-bg}",placeholder:"Your header",line:!0,block:!1},quote:{start:"> ",end:"",placeholder:"Your quote",line:!0,block:!1},link:{start:"[",end:"](https://example.org/)",placeholder:"Add your link text",line:!1,block:!1},image:{start:"![",end:"](https://example.org/)",placeholder:"Add image description",line:!1,block:!1},imageleft:{start:"![",end:"](https://example.org/){.news-image-left}",placeholder:"Add image description",line:!1,block:!1},imageright:{start:"![",end:"](https://example.org/){.news-image-right}",placeholder:"Add image description",line:!1,block:!1},code:{start:"`",end:"`",placeholder:"Add inline code here",line:!1,block:!1},pre:{start:"    ",end:"",placeholder:"Block Code",line:!0,block:!0},ul:{start:"* ",end:"",placeholder:"List Item",line:!0,block:!0},ol:{start:"1. ",end:"",placeholder:"List Item",line:!0,block:!0},break:{start:"",end:"\n{.clearfix}",placeholder:"",line:!0,block:!0},custom:{start:"",end:" {.custom-class-here}",placeholder:"",line:!0,block:!0}};return this.each((function(){let a=this,s=!0,i=e(this).data("endpoint")||"/api/md_preview/",r=e('<div class="controls" id="'+a.id+'-controls" />');stalePreviewIcon="fa-eye-slash",previewSource=r,t&&(previewSource=e(".full-preview"),stalePreviewIcon="fa-check");const o="btn btn-light",c='<button type="button" data-toggle="tooltip" data-placement="bottom" title="';var d='<div class="btn-toolbar" role="toolbar" aria-label="Markdown Toolbar"><div class="btn-group mr-2 mb-1" role="group" aria-label="Formatting">'+c+'Bold" class="'+'btn btn-light c-bold"><i class="fas fa-bold"></i></button>'+c+'Italic" class="'+'btn btn-light c-italic"><i class="fas fa-italic"></i></button>'+c+'Strikethrough" class="'+'btn btn-light c-strike"><i class="fas fa-strikethrough"></i></button>'+c+'Code" class="'+'btn btn-light c-code"><i class="fas fa-code"></i></button>';d+=t?c+'Heading 2" class="'+'btn btn-light c-h2news"><i class="fas fa-heading"></i>2</button>'+c+'Heading 3" class="'+'btn btn-light c-h3news"><i class="fas fa-heading"></i>3</button>':c+'Heading" class="'+'btn btn-light c-h1"><i class="fas fa-heading"></i></button>',d+=c+'Quote" class="'+'btn btn-light c-quote"><i class="fas fa-quote-right"></i></button></div><div class="btn-group mr-2 mb-1" role="group" aria-label="Utilities">'+c+'Link" class="'+'btn btn-light c-link"><i class="fas fa-link"></i></button>'+c+'Image" class="'+'btn btn-light c-image"><i class="fas fa-image"></i></button>',t&&(d+=c+'Image (Left, 50% Width)" class="'+'btn btn-light c-imageleft"><i class="fas fa-caret-left"></i>&nbsp;<i class="fas fa-image"></i></button>'+c+'Image (Right, 50% Width)" class="'+'btn btn-light c-imageright"><i class="fas fa-image"></i>&nbsp;<i class="fas fa-caret-right"></i></button>'),d+='</div><div class="btn-group mr-2 mb-1" role="group" aria-label="Lists">'+c+'Bullet List" class="'+'btn btn-light c-ul"><i class="fas fa-list-ul"></i></button>'+c+'Ordered List" class="'+'btn btn-light c-ol"><i class="fas fa-list-ol"></i></button>',t&&(d+='</div><div class="btn-group mr-2 mb-1" role="group" aria-label="Classes">'+c+'Section Break" class="'+'btn btn-light c-break"><i class="fas fa-level-down-alt"></i></button>'+c+'Custom Class" class="'+'btn btn-light c-custom"><i class="fas fa-hammer"></i></button><button type="button" data-placement="bottom" title="Help" class="'+'btn btn-light c-help" data-toggle="modal" data-target="#helpmodal"><i class="fas fa-question"></i></button>'),d+='</div><div class="btn-group mr-2 mb-1" role="group" aria-label="Preview">'+c+'Preview" class="'+'btn btn-light c-preview"><i class="fas fa-eye"></i></button></div></div>',t||(d+='<div class="preview"></div>');let u,b=function(){return s?(s=!1,r.find(".fa-eye").removeClass("fa-eye").addClass(stalePreviewIcon),createPreview(a,previewSource,i)):(t||previewSource.find(".preview").slideUp(),r.find("."+stalePreviewIcon).removeClass(stalePreviewIcon).addClass("fa-eye"),s=!0),!0};t&&(u=setTimeout(b,1)),e(a).before(r.append(d)),t||r.find(".preview").slideUp(),e(a).on("keydown",(function(e){return previewSource.find(".card").addClass("text-muted"),r.find("."+stalePreviewIcon).removeClass(stalePreviewIcon).addClass("fa-eye"),s=!0,t&&(clearTimeout(u),u=setTimeout(b,600)),MarkdownHelper(a,e)})),e("button",r).on("click",(function(e){e.preventDefault(),a.focus();let i=this.className.substr(o.length+3),c={start:a.selectionStart,end:a.selectionEnd},d=l[i];if("preview"===i)return b();if("help"===i)return!0;let g=toLines(a.value,c),h=g.lines,f=g.selection;d===l.code&&f.start.line!==f.end.line&&(d=l.pre);let p=0,m=0;if(d.line)if(f.start.line===f.end.line&&""===h[f.start.line])h[f.start.line]=d.start+d.placeholder+d.end,m+=length(h[f.start.line]);else{p+=length(d.start);for(let e=f.start.line;e<=f.end.line;e++)h[e]=d.start+h[e]+d.end,m+=length(d.start)}else c.start!==c.end?(h[f.end.line]=h[f.end.line].substring(0,f.end.pos)+d.end+h[f.end.line].substring(f.end.pos),h[f.start.line]=h[f.start.line].substring(0,f.start.pos)+d.start+h[f.start.line].substring(f.start.pos),p+=length(d.start),m+=length(d.start)):(h[f.start.line]=h[f.start.line].substring(0,f.start.pos)+d.start+d.placeholder+d.end+h[f.start.line].substring(f.start.pos),p+=length(d.start),m+=length(d.start+d.placeholder));return d.block&&f.start.line-1>=0&&""!==h[f.start.line-1]&&(h[f.start.line]="\n"+h[f.start.line],p+=1),d.block&&f.end.line+1<=h.length&&""!==h[f.end.line+1]&&(h[f.end.line]=h[f.end.line]+"\n"),a.value=h.join("\n"),function(e,t,l){if(e.focus(),e.setSelectionRange)e.setSelectionRange(n(e,t),n(e,l));else if(e.createTextRange){let n=e.createTextRange();n.collapse(!0),n.moveEnd("character",l),n.moveStart("character",t),n.select()}}(a,c.start+p,c.end+m),s=!0,previewSource.find(".card").addClass("text-muted"),r.find("."+stalePreviewIcon).removeClass(stalePreviewIcon).addClass("fa-eye"),t&&(clearTimeout(u),u=setTimeout(b,600)),!0}))}))}}(jQuery,window,document);